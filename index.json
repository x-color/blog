[{"content":"タグ付けを忘れがち 普段の業務では単一の AWS アカウントを複数のプロダクトの開発に利用している。 その場合に気になってくるのがコスト。 気づいたときには「今月の請求が。。」みたいなことにならないためにも、どのプロダクトがどのリソースを利用しており、それぞれどの程度利用料が発生しているのかを把握することはとても重要。\nこのニーズを満たすために、AWS ではコスト配分タグという機能がある。これを用いることで、タグごとにリソースのコストを把握する事ができる。\n自分は普段、なにかを構築する際には CloudFormation を利用する事が多い。 コスト配分タグを最大限活用するためにも可能な限りリソースにはタグ付けをするようにしている。\nしかし、多くのリソースを構築していると一部リソースのタグ付けを忘れてしまうことがある。おかげでタグで追跡できないリソースが作成され、「これコストかかっているけど、どのプロダクトのリソース？」といったことが発生する。\n※CloudFormation スタックのタグ付けの伝搬でいいのではと最初思っていたのだが、意外とタグが伝搬されないリソースが多いので各種リソースに明示的につけるようにしている。\n忘れないために自動でテストしよう レビュー時に、テンプレートで定義されたすべてのリソースが正しくタグ付けされているかをチェックするのもいいが、そもそも「どのリソースはタグ付け可能だっけ？」となったりしてあまりにも大変。\nというわけで人の手を借りずに自動でチェックさせるために、タグ付け可能なリソースがすべて適切なタグ付けがされているかをテストするための仕組みをOpen Policy Agentを用いて実装した。\n\nちなみに、CloudFormation は高頻度で更新がかかり、随時新たなリソースの追加やタグ付けがサポートされる。 そのため、このリポジトリでは GitHub Actions を利用して、CloudFormation の更新を追いかけ、更新があるたびにポリシーファイルを更新している。 利用する場合はなるべく最新版をダウンロードして利用してもらいたい。\nテストしてみる 実際に利用してみる。今回は、タグ付け可能なリソース全てに「System」タグが付けられていることをテストする。\nなお、ここにもサンプルのポリシーや CloudFormation テンプレートを用意している。\nテストのための準備 ディレクトリ構成は下記とする\n. ├── policy │ └── deny.rego # 実際のポリシーを定義 └── templates └── template.yaml # タグ付けされていないリソースが定義されたCloudFormationテンプレート テスト対象とする CloudFormation テンプレートは下記とする。（templates/template.yaml）\nAWSTemplateFormatVersion: 2010-09-09 Parameters: VpcCidr: Type: String Resources: VPC: Type: AWS::EC2::VPC Properties: CidrBlock: !Ref VpcCidr このテンプレートでは、指定された Cidr ブロックを持つ VPC を作成するが、「System」タグを付け忘れている。\nタグ付けチェック用のポリシーファイルの作成 次にpolicy/deny.rego に 「System」タグが付与されていない場合に警告されるポリシーを定義する。\n# policy/deny.rego package policy import data.cloudformation as cfn # 「opa-cfn-tag-policy」のポリシーをインポート deny[reason] { some id rs := input.Resources[id] # *1 not cfn.resource_has_tag(rs, \u0026quot;System\u0026quot;) # *2 reason = sprintf(\u0026quot;No 'System' tag: %v\u0026quot;, [id]) # *3 } 処理の流れは下記となっている。\n 処理中のリソース名をidに格納しつつ、すべてのリソースを取得 対象のリソースが「System」タグを持っているか確認 「System」タグを持っていないリソースに対してリソース名を含んだ警告文を返す  なお、このあとのテスト時の手順に入っているが、テスト実行前に上記リポジトリ内のタグ付けされているかチェックする関数を定義しているポリシーファイルをダウンロードする必要がある。\nポリシーを用いてテスト Open Policy Agent の CLI を用いてチェックする場合は下記コマンドでチェック可能。\n# 「opa-cfn-tag-policy」リポジトリ内のタグ付けポリシーをダウンロード $ curl -L -o policy/cfn_tag.rego https://raw.githubusercontent.com/x-color/opa-cfn-tag-policy/main/policy/cfn_tag.rego # テストの実施 $ opa eval -d policy -i templates/template.yaml data.policy { \u0026#34;result\u0026#34;: [ { \u0026#34;expressions\u0026#34;: [ { \u0026#34;value\u0026#34;: { \u0026#34;deny\u0026#34;: [ \u0026#34;No \u0026#39;System\u0026#39; tag: VPC\u0026#34; # 「VPC」に「System」タグがないと報告されている ] }, \u0026#34;text\u0026#34;: \u0026#34;data.policy\u0026#34;, \u0026#34;location\u0026#34;: { \u0026#34;row\u0026#34;: 1, \u0026#34;col\u0026#34;: 1 } } ] } ] } Conftestを用いるとより簡単にテストすることが可能。\n# 「opa-cfn-tag-policy」リポジトリ内のタグ付けポリシーをダウンロード $ conftest pull https://raw.githubusercontent.com/x-color/opa-cfn-tag-policy/main/policy/cfn_tag.rego # テストの実施 $ conftest test -n policy templates FAIL - templates/vpc-template.yaml - policy - No \u0026#39;System\u0026#39; tag: VPC 1 test, 0 passed, 0 warnings, 1 failure, 0 exceptions さいごに 実際に作成したテストの仕組みは CI/CD パイプラインに組み込んでおり、おかげで CloudFormation テンプレートで作成するリソースのタグ付けを忘れることがなくなった。\nタグ付け忘れで、用途不明なリソースができていてコスト管理などで困っている場合は、ぜひ利用してみてほしい。\n","permalink":"https://x-color.github.io/blog/posts/opa-cfn-tag-policy/","summary":"タグ付けを忘れがち 普段の業務では単一の AWS アカウントを複数のプロダクトの開発に利用している。 その場合に気になってくるのがコスト。 気づいたときには「今月の請求が。。」みたいなことにならないためにも、どのプロダクトがどのリソースを利用しており、それぞれどの程度利用料が発生しているのかを把握することはとても重要。\nこのニーズを満たすために、AWS ではコスト配分タグという機能がある。これを用いることで、タグごとにリソースのコストを把握する事ができる。\n自分は普段、なにかを構築する際には CloudFormation を利用する事が多い。 コスト配分タグを最大限活用するためにも可能な限りリソースにはタグ付けをするようにしている。\nしかし、多くのリソースを構築していると一部リソースのタグ付けを忘れてしまうことがある。おかげでタグで追跡できないリソースが作成され、「これコストかかっているけど、どのプロダクトのリソース？」といったことが発生する。\n※CloudFormation スタックのタグ付けの伝搬でいいのではと最初思っていたのだが、意外とタグが伝搬されないリソースが多いので各種リソースに明示的につけるようにしている。\n忘れないために自動でテストしよう レビュー時に、テンプレートで定義されたすべてのリソースが正しくタグ付けされているかをチェックするのもいいが、そもそも「どのリソースはタグ付け可能だっけ？」となったりしてあまりにも大変。\nというわけで人の手を借りずに自動でチェックさせるために、タグ付け可能なリソースがすべて適切なタグ付けがされているかをテストするための仕組みをOpen Policy Agentを用いて実装した。\n\nちなみに、CloudFormation は高頻度で更新がかかり、随時新たなリソースの追加やタグ付けがサポートされる。 そのため、このリポジトリでは GitHub Actions を利用して、CloudFormation の更新を追いかけ、更新があるたびにポリシーファイルを更新している。 利用する場合はなるべく最新版をダウンロードして利用してもらいたい。\nテストしてみる 実際に利用してみる。今回は、タグ付け可能なリソース全てに「System」タグが付けられていることをテストする。\nなお、ここにもサンプルのポリシーや CloudFormation テンプレートを用意している。\nテストのための準備 ディレクトリ構成は下記とする\n. ├── policy │ └── deny.rego # 実際のポリシーを定義 └── templates └── template.yaml # タグ付けされていないリソースが定義されたCloudFormationテンプレート テスト対象とする CloudFormation テンプレートは下記とする。（templates/template.yaml）\nAWSTemplateFormatVersion: 2010-09-09 Parameters: VpcCidr: Type: String Resources: VPC: Type: AWS::EC2::VPC Properties: CidrBlock: !Ref VpcCidr このテンプレートでは、指定された Cidr ブロックを持つ VPC を作成するが、「System」タグを付け忘れている。","title":"CloudFormationで作成するリソースのタグ付けを強制する"}]