<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>cloudformation on x-color&#39;s blog</title>
    <link>https://x-color.github.io/blog/tags/cloudformation/</link>
    <description>Recent content in cloudformation on x-color&#39;s blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Mon, 31 May 2021 10:00:00 +0900</lastBuildDate><atom:link href="https://x-color.github.io/blog/tags/cloudformation/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>CloudFormationで作成するリソースのタグ付けを強制する</title>
      <link>https://x-color.github.io/blog/posts/opa-cfn-tag-policy/</link>
      <pubDate>Mon, 31 May 2021 10:00:00 +0900</pubDate>
      
      <guid>https://x-color.github.io/blog/posts/opa-cfn-tag-policy/</guid>
      <description>タグ付けを忘れがち 普段の業務では単一の AWS アカウントを複数のプロダクトの開発に利用している。 その場合に気になってくるのがコスト。 気づいたときには「今月の請求が。。」みたいなことにならないためにも、どのプロダクトがどのリソースを利用しており、それぞれどの程度利用料が発生しているのかを把握することはとても重要。
このニーズを満たすために、AWS ではコスト配分タグという機能がある。これを用いることで、タグごとにリソースのコストを把握する事ができる。
自分は普段、なにかを構築する際には CloudFormation を利用する事が多い。 コスト配分タグを最大限活用するためにも可能な限りリソースにはタグ付けをするようにしている。
しかし、多くのリソースを構築していると一部リソースのタグ付けを忘れてしまうことがある。おかげでタグで追跡できないリソースが作成され、「これコストかかっているけど、どのプロダクトのリソース？」といったことが発生する。
※CloudFormation スタックのタグ付けの伝搬でいいのではと最初思っていたのだが、意外とタグが伝搬されないリソースが多いので各種リソースに明示的につけるようにしている。
忘れないために自動でテストしよう レビュー時に、テンプレートで定義されたすべてのリソースが正しくタグ付けされているかをチェックするのもいいが、そもそも「どのリソースはタグ付け可能だっけ？」となったりしてあまりにも大変。
というわけで人の手を借りずに自動でチェックさせるために、タグ付け可能なリソースがすべて適切なタグ付けがされているかをテストするための仕組みをOpen Policy Agentを用いて実装した。

ちなみに、CloudFormation は高頻度で更新がかかり、随時新たなリソースの追加やタグ付けがサポートされる。 そのため、このリポジトリでは GitHub Actions を利用して、CloudFormation の更新を追いかけ、更新があるたびにポリシーファイルを更新している。 利用する場合はなるべく最新版をダウンロードして利用してもらいたい。
テストしてみる 実際に利用してみる。今回は、タグ付け可能なリソース全てに「System」タグが付けられていることをテストする。
なお、ここにもサンプルのポリシーや CloudFormation テンプレートを用意している。
テストのための準備 ディレクトリ構成は下記とする
. ├── policy │ └── deny.rego # 実際のポリシーを定義 └── templates └── template.yaml # タグ付けされていないリソースが定義されたCloudFormationテンプレート テスト対象とする CloudFormation テンプレートは下記とする。（templates/template.yaml）
AWSTemplateFormatVersion: 2010-09-09 Parameters: VpcCidr: Type: String Resources: VPC: Type: AWS::EC2::VPC Properties: CidrBlock: !Ref VpcCidr このテンプレートでは、指定された Cidr ブロックを持つ VPC を作成するが、「System」タグを付け忘れている。</description>
    </item>
    
  </channel>
</rss>
